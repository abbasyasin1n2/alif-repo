
{% extends "base.html" %}

{% block title %}Traceability Report{% endblock %}

{% block content %}
<div class="animate__animated animate__fadeIn">
    <h2 class="header">Traceability Report</h2>

    <div class="card-panel-new">
        <form method="POST" class="trace-form">
            <div class="input-field">
                <select name="batch_id" id="batch_id">
                    <option value="" disabled selected>Choose a batch to trace</option>
                    {% for b in batches %}
                        <option value="{{ b.id }}" {% if batch and b.id == batch.id %}selected{% endif %}>
                            {{ b.product_name }} - Batch #{{ b.batch_number }}
                        </option>
                    {% endfor %}
                </select>
                <label>Select Batch</label>
            </div>
            <button class="btn waves-effect waves-light action-btn" type="submit"><i class="ti ti-search left"></i>Generate Report</button>
        </form>
    </div>

    {% if batch %}
    <div class="card-panel-new animate__animated animate__fadeInUp">
        <span class="card-title"><h4>Traceability Details for Batch #{{ batch.batch_number }}</h4></span>
        
        <div class="row">
            <div class="col s12 m6">
                <h5><i class="ti ti-box-seam"></i> Batch Information</h5>
                <p><strong>Product:</strong> {{ product.name }}</p>
                <p><strong>Arrival Date:</strong> {{ batch.arrival_date }}</p>
                <p><strong>Expiration Date:</strong> {{ batch.expiration_date }}</p>
            </div>
            <div class="col s12 m6">
                <h5><i class="ti ti-truck-delivery"></i> Supplier Information</h5>
                {% if supplier %}
                    <p><strong>Name:</strong> {{ supplier.name }}</p>
                    <p><strong>Contact:</strong> {{ supplier.contact_person }} ({{ supplier.email }})</p>
                {% else %}
                    <p>No supplier information available.</p>
                {% endif %}
            </div>
        </div>

        <div class="divider" style="margin: 20px 0;"></div>

        <h5><i class="ti ti-settings-cog"></i> Processing History</h5>
        {% if usage %}
            {% for use in usage %}
            <div class="card-panel-new-nested">
                <h6><i class="ti ti-arrow-right"></i> Used in Session: <a href="{{ url_for('processing.view_session', id=use.session.id) }}">{{ use.session.session_name }}</a> on {{ use.session.session_date }}</h6>
                <p><strong>Outputs from this session:</strong></p>
                <ul class="browser-default">
                    {% for output in use.outputs %}
                        <li>{{ output.product_name }} ({{ output.output_type }}) - {{ output.weight }} kg</li>
                    {% else %}
                        <li>No outputs recorded for this session.</li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        {% else %}
            <p>This batch has not been used in any processing sessions.</p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
    });
</script>
{% endblock %}
